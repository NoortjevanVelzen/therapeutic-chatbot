// src/components/SocialMediaScreen.js

import React, { useState, useEffect } from "react";
import axios from "axios";
import styles from "./SocialMediaScreen.module.css";

const BACKEND_URL = "http://localhost:5000";

function generatePromptForMood(mood) {
  if (!mood || typeof mood !== "string" || mood.trim() === "") {
    mood = "neutral";
  }
  return `A stylized photo instagram post (without the UI) designed to support the mood '${mood}':

‚Äì If negative (anxious, sad, angry, overwhelmed): show a peaceful scene like gentle ocean waves, soft pastel colors, and a minimal layout with a calm tone.
‚Äì If neutral: show an uplifting article preview or news snippet with balanced composition, soft lighting, and a hint of curiosity or inspiration (like a sunrise or a glowing headline).
‚Äì If positive: display a cheerful, vibrant post celebrating joy‚Äîbright colors, confetti, smiling icons, or a celebration scene.

Requirements:
‚Ä¢ Clean layout, subtle shadows, realistic or semi-realistic visual style.`;
}

function SocialMediaScreen({ mood }) {
  const [images, setImages] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    console.log("Received mood from backend:", mood);
  }, [mood]);

  useEffect(() => {
    async function fetchImages() {
      setLoading(true);
      setError(null);
      setImages([]);
      const prompt = generatePromptForMood(mood);
      try {
        const response = await axios.post(`${BACKEND_URL}/api/generate-image`, {
          prompt,
        });
        setImages(response.data.images || []);
      } catch (e) {
        setImages([]);
        setError(
          e.response?.data?.error || "Image generation failed."
        );
      }
      setLoading(false);
    }
    fetchImages();
  }, [mood]);

  return (
    <div className={styles.feedContainer}>
      <div className={styles.moodInfoBox}>
        <span className={styles.moodLabel}>Mood detected:&nbsp;</span>
        <span className={styles.moodValue}>{mood || "neutral"}</span>
        <div className={styles.moodDescription}>
          The feed below is generated by AI to mentally balance your mood.
        </div>
      </div>

      <h2 className={styles.feedTitle}>Your Balanced Feed</h2>

      {error && <div className={styles.error}>{error}</div>}

      {loading ? (
        <p className={styles.loading}>Generating images...</p>
      ) : (
        <div className={styles.imageGrid}>
          {images.length > 0 ? (
            images.map((img, idx) => (
              <div key={idx} className={styles.imageCard}>
                <div className={styles.imageHeader}>
                  <img
                    src="/chatbot-avatar.png"
                    alt="avatar"
                    className={styles.avatarSmall}
                  />
                  <span className={styles.username}>AI_Generator</span>
                </div>
                <img
                  src={img}
                  alt={`mood img ${idx}`}
                  className={styles.image}
                />
                <div className={styles.reactions}>
                  <span>‚ù§Ô∏è</span>
                  <span>üí¨</span>
                  <span>üì§</span>
                </div>
                <div className={styles.caption}>
                  <strong>AI_Generator</strong>
                  This mock-up post was created to gently shift you out of feeling {mood}, and into a better headspace.
                  <div className={styles.captionTag}>#{mood}vibes</div>
                </div>
              </div>
            ))
          ) : (
            <div className={styles.noImages}>No images generated.</div>
          )}
        </div>
      )}
    </div>
  );
}

export default SocialMediaScreen;
